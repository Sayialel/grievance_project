{% extends 'base.html' %}
{% load static %}
{% block title %}Admin Dashboard{% endblock %}

{% block content %}
<div class="container-fluid py-5 px-4" style="background: linear-gradient(135deg, #115740 0%, #1a8753 100%); min-height: 100vh;">
  <div class="row justify-content-center mb-4">
    <div class="col-12 text-center">
      <div class="text-warning mb-2">
        <i class="fas fa-user-cog fa-3x"></i>
      </div>
      <h2 class="text-white fw-bold">Environmental Admin Dashboard</h2>
      <p class="lead text-white-50">Manage the entire environmental reporting system</p>
    </div>
  </div>

  <!-- Direct Navigation Links -->
  <ul class="nav nav-justified mb-4" id="adminTabs">
    <li class="nav-item px-1">
      <a class="nav-link {% if not active_tab or active_tab == 'overview' %}active{% endif %} text-white border-0 w-100" href="{% url 'dashboard:admin_dashboard' %}" style="background-color: {% if not active_tab or active_tab == 'overview' %}#27ae60{% else %}rgba(255,255,255,0.2){% endif %}; border-radius: 0.5rem;">
        <i class="fas fa-tachometer-alt me-2"></i>Dashboard Overview
      </a>
    </li>
    <li class="nav-item px-1">
      <a class="nav-link {% if active_tab == 'complaints' %}active{% endif %} text-white border-0 w-100" href="{% url 'dashboard:admin_dashboard' %}?tab=complaints" style="background-color: {% if active_tab == 'complaints' %}#27ae60{% else %}rgba(255,255,255,0.2){% endif %}; border-radius: 0.5rem;">
        <i class="fas fa-clipboard-list me-2"></i>Complaint Management
      </a>
    </li>
    <li class="nav-item px-1">
      <a class="nav-link {% if active_tab == 'officers' %}active{% endif %} text-white border-0 w-100" href="{% url 'dashboard:admin_dashboard' %}?tab=officers" style="background-color: {% if active_tab == 'officers' %}#27ae60{% else %}rgba(255,255,255,0.2){% endif %}; border-radius: 0.5rem;">
        <i class="fas fa-users me-2"></i>Officer Management
      </a>
    </li>
    <li class="nav-item px-1">
      <a class="nav-link {% if active_tab == 'reports' %}active{% endif %} text-white border-0 w-100" href="{% url 'dashboard:admin_dashboard' %}?tab=reports" style="background-color: {% if active_tab == 'reports' %}#27ae60{% else %}rgba(255,255,255,0.2){% endif %}; border-radius: 0.5rem;">
        <i class="fas fa-chart-bar me-2"></i>Reports & Analytics
      </a>
    </li>
  </ul>

  <!-- Content Section -->
  <div id="adminContent">
    <!-- Dashboard Overview Content -->
    {% if not active_tab or active_tab == 'overview' %}
      <div class="row g-4">
        <div class="col-12 col-xl-8">
          <div class="card border-0 shadow-lg mb-4" style="background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); border-radius: 15px;">
            <div class="card-header bg-transparent d-flex justify-content-between align-items-center py-4 border-0">
              <div class="d-flex align-items-center">
                <div class="bg-success rounded-circle d-flex align-items-center justify-content-center me-3" style="width: 45px; height: 45px;">
                  <i class="fas fa-chart-line text-white"></i>
                </div>
                <h4 class="mb-0 text-success">System Overview</h4>
              </div>
              <span class="badge bg-danger px-3 py-2">Administrator</span>
            </div>
                  <div class="card-body p-4">
          <div class="row g-4 mb-4">
            <div class="col-md-3">
              <div class="card border-0 shadow h-100" style="background: linear-gradient(45deg, #3498db, #2980b9); border-radius: 15px;">
                <div class="card-body text-center p-4">
                  <div class="text-white mb-3 opacity-75">
                    <i class="fas fa-clipboard-list fa-2x"></i>
                  </div>
                  <h6 class="card-title text-white mb-3">Total Complaints</h6>
                  <h2 class="display-4 text-white fw-bold mb-0">{{ total_complaints }}</h2>
                  <div class="mt-3 text-white-50 small">Environmental issues reported</div>
                </div>
              </div>
            </div>
            <div class="col-md-3">
              <div class="card border-0 shadow h-100" style="background: linear-gradient(45deg, #f39c12, #d35400); border-radius: 15px;">
                <div class="card-body text-center p-4">
                  <div class="text-white mb-3 opacity-75">
                    <i class="fas fa-exclamation-triangle fa-2x"></i>
                  </div>
                  <h6 class="card-title text-white mb-3">Pending</h6>
                  <h2 class="display-4 text-white fw-bold mb-0">{{ pending_count }}</h2>
                  <div class="mt-3 text-white-50 small">Awaiting assignment</div>
                </div>
              </div>
            </div>
            <div class="col-md-3">
              <div class="card border-0 shadow h-100" style="background: linear-gradient(45deg, #3498db, #2980b9); border-radius: 15px;">
                <div class="card-body text-center p-4">
                  <div class="text-white mb-3 opacity-75">
                    <i class="fas fa-spinner fa-2x"></i>
                  </div>
                  <h6 class="card-title text-white mb-3">In Progress</h6>
                  <h2 class="display-4 text-white fw-bold mb-0">{{ in_progress_count }}</h2>
                  <div class="mt-3 text-white-50 small">Being addressed</div>
                </div>
              </div>
            </div>
            <div class="col-md-3">
              <div class="card border-0 shadow h-100" style="background: linear-gradient(45deg, #2ecc71, #27ae60); border-radius: 15px;">
                <div class="card-body text-center p-4">
                  <div class="text-white mb-3 opacity-75">
                    <i class="fas fa-check-circle fa-2x"></i>
                  </div>
                  <h6 class="card-title text-white mb-3">Resolved</h6>
                  <h2 class="display-4 text-white fw-bold mb-0">{{ resolved_count }}</h2>
                  <div class="mt-3 text-white-50 small">Successfully addressed</div>
                </div>
              </div>
            </div>
          </div>

          <h5 class="fw-bold text-success mb-4"><i class="fas fa-chart-pie me-2"></i>Environmental Management Overview</h5>
          <div class="row g-4">
            <div class="col-md-6">
              <div class="card border-0 shadow h-100" style="border-radius: 15px; overflow: hidden;">
                <div class="card-body p-4">
                  <div class="d-flex align-items-center mb-3">
                    <div class="bg-success rounded-circle d-inline-flex align-items-center justify-content-center me-3" style="width: 45px; height: 45px;">
                      <i class="fas fa-users text-white"></i>
                    </div>
                    <h5 class="card-title mb-0 text-success">Environmental Officers</h5>
                  </div>
                  <div class="d-flex align-items-center mb-3">
                    <div class="display-4 fw-bold text-success me-3">{{ total_officers }}</div>
                    <div class="text-muted">Active officers monitoring environmental issues across regions</div>
                  </div>
                  <div class="progress mb-3" style="height: 8px; border-radius: 4px;">
                    <div class="progress-bar bg-success" role="progressbar" style="width: {{ officers_percentage }}%;" aria-valuenow="{{ officers_percentage }}" aria-valuemin="0" aria-valuemax="100"></div>
                  </div>
                </div>
                <div class="card-footer bg-transparent border-top p-3">
                  <a href="{% url 'dashboard:admin_dashboard' %}?tab=officers" class="btn btn-success w-100">
                    <i class="fas fa-user-cog me-2"></i> Manage Environmental Officers
                  </a>
                </div>
              </div>
            </div>

            <div class="col-md-6">
              <div class="card border-0 shadow h-100" style="border-radius: 15px; overflow: hidden;">
                <div class="card-body p-4">
                  <div class="d-flex align-items-center mb-3">
                    <div class="bg-success rounded-circle d-inline-flex align-items-center justify-content-center me-3" style="width: 45px; height: 45px;">
                      <i class="fas fa-leaf text-white"></i>
                    </div>
                    <h5 class="card-title mb-0 text-success">Environmental Impact</h5>
                  </div>
                  <h6 class="mb-3">Resolution Rate</h6>
                  {% if total_complaints > 0 %}
                      <div class="progress mb-3" style="height: 25px; border-radius: 12px; box-shadow: inset 0 1px 3px rgba(0,0,0,0.2);">
                        <div class="progress-bar bg-success" role="progressbar" style="width: {{ resolution_rate }}%; border-radius: 12px;" 
                             aria-valuenow="{{ resolution_rate }}" aria-valuemin="0" aria-valuemax="100">
                          {{ resolution_rate }}%
                        </div>
                      </div>
                      <div class="d-flex justify-content-between">
                        <span class="badge bg-success px-3 py-2 rounded-pill">{{ resolved_count }} resolved</span>
                        <span class="text-muted">out of {{ total_complaints }} total reports</span>
                      </div>
                      <div class="mt-3 text-center">
                        <div class="eco-impact-meter d-flex justify-content-between">
                          <span><i class="fas fa-seedling text-success"></i></span>
                          <span><i class="fas fa-tree text-success"></i></span>
                          <span><i class="fas fa-forest text-success"></i></span>
                        </div>
                        <div class="text-muted small mt-1">Environmental impact level</div>
                      </div>
                  {% else %}
                    <div class="alert" style="background-color: rgba(46,204,113,0.1); color: #27ae60; border-radius: 10px; border-left: 4px solid #27ae60;">
                      <i class="fas fa-info-circle me-2"></i>
                      No environmental issues have been reported yet.
                    </div>
                  {% endif %}
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-12 col-xl-4">
      <div class="card border-0 shadow-lg mb-4" style="background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); border-radius: 15px;">
        <div class="card-header bg-transparent border-0 py-4">
          <div class="d-flex align-items-center">
            <div class="bg-success rounded-circle d-inline-flex align-items-center justify-content-center me-3" style="width: 45px; height: 45px;">
              <i class="fas fa-sliders-h text-white"></i>
            </div>
            <h4 class="mb-0 text-success">Administrator Controls</h4>
          </div>
        </div>
        <div class="card-body p-4">
          <div class="d-flex align-items-center p-3 mb-4 rounded-3" style="background: rgba(46,204,113,0.1);">
            <div class="bg-success rounded-circle d-flex align-items-center justify-content-center me-3" style="width: 60px; height: 60px;">
              <i class="fas fa-user-shield fa-2x text-white"></i>
            </div>
            <div>
              <h5 class="text-success mb-1">{{ email }}</h5>
              <div class="d-flex align-items-center">
                <span class="badge bg-success me-2">System Administrator</span>
                <span class="text-muted small"><i class="fas fa-circle text-success me-1" style="font-size: 8px;"></i> Online</span>
              </div>
            </div>
          </div>

          <div class="list-group mb-4" style="border-radius: 10px; overflow: hidden;">
            <a href="{% url 'dashboard:admin_dashboard' %}?tab=officers" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center p-3 border-0 mb-2" style="background: rgba(46,204,113,0.1); border-radius: 10px;">
              <div class="d-flex align-items-center">
                <div class="bg-success rounded-circle d-flex align-items-center justify-content-center me-3" style="width: 40px; height: 40px;">
                  <i class="fas fa-users text-white"></i>
                </div>
                <span class="text-success">Manage Officers</span>
              </div>
              <span class="badge bg-success rounded-pill px-3">{{ total_officers }}</span>
            </a>
            <a href="{% url 'dashboard:admin_dashboard' %}?tab=complaints" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center p-3 border-0 mb-2" style="background: rgba(52,152,219,0.1); border-radius: 10px;">
              <div class="d-flex align-items-center">
                <div class="bg-info rounded-circle d-flex align-items-center justify-content-center me-3" style="width: 40px; height: 40px;">
                  <i class="fas fa-clipboard-list text-white"></i>
                </div>
                <span class="text-info">All Complaints</span>
              </div>
              <span class="badge bg-info rounded-pill px-3">{{ total_complaints }}</span>
            </a>
            
            <a href="{% url 'dashboard:admin_dashboard' %}?tab=reports" class="list-group-item list-group-item-action d-flex align-items-center p-3 border-0" style="background: rgba(241,196,15,0.1); border-radius: 10px;">
              <div class="bg-warning rounded-circle d-flex align-items-center justify-content-center me-3" style="width: 40px; height: 40px;">
                <i class="fas fa-chart-bar text-white"></i>
              </div>
              <span class="text-warning">Environmental Reports</span>
            </a>
          </div>

          
        </div>
      </div>
    </div>
    {% endif %}
    <!-- End of Overview Content -->

    <!-- Complaints Management Content -->
    {% if active_tab == 'complaints' %}
      <div class="card border-0 shadow-lg mb-4" style="background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); border-radius: 15px;">
        <div class="card-header bg-transparent py-4 border-0">
          <div class="d-flex justify-content-between align-items-center">
            <div class="d-flex align-items-center">
              <div class="bg-success rounded-circle d-inline-flex align-items-center justify-content-center me-3" style="width: 45px; height: 45px;">
                <i class="fas fa-clipboard-list text-white"></i>
              </div>
              <h4 class="card-title mb-0 text-success">Environmental Complaints</h4>
            </div>
            <div>
              <button type="button" class="btn btn-success" data-bs-toggle="collapse" data-bs-target="#filterCollapse">
                <i class="fas fa-filter me-2"></i>Filter &amp; Search
              </button>
            </div>
          </div>
        </div>

        <!-- Advanced Filter Panel -->
        <div class="collapse" id="filterCollapse">
          <div class="card-body bg-light">
            <form method="get" action="." class="row g-3">
              <!-- Search field -->
              <div class="col-md-12">
                <div class="input-group mb-3">
                  <span class="input-group-text"><i class="fas fa-search"></i></span>
                  {{ filter_form.search_text }}
                  <button class="btn btn-success" type="submit">Search</button>
                </div>
              </div>

              <!-- Status filter -->
              <div class="col-md-3">
                <h6>Status</h6>
                <div class="bg-white p-3 rounded shadow-sm">
                  {{ filter_form.status }}
                </div>
              </div>

              <!-- Category filter -->
              <div class="col-md-3">
                <h6>Category</h6>
                <div class="bg-white p-3 rounded shadow-sm">
                  {{ filter_form.category }}
                </div>
              </div>

              <!-- Location filter -->
              <div class="col-md-3">
                <h6>Constituency</h6>
                <div class="bg-white p-3 rounded shadow-sm">
                  {{ filter_form.location }}
                </div>
              </div>

              <!-- Date range -->
              <div class="col-md-3">
                <h6>Date Range</h6>
                <div class="bg-white p-3 rounded shadow-sm">
                  <div class="mb-2">
                    <label class="form-label small">From</label>
                    {{ filter_form.date_from }}
                  </div>
                  <div>
                    <label class="form-label small">To</label>
                    {{ filter_form.date_to }}
                  </div>
                </div>
              </div>

              <!-- Reporter filter -->
              <div class="col-md-4">
                <h6>Reporter Email</h6>
                {{ filter_form.reported_by }}
              </div>

              <!-- Officer filter -->
              <div class="col-md-4">
                <h6>Assigned Officer</h6>
                {{ filter_form.assigned_officer }}
              </div>

              <!-- Sort by -->
              <div class="col-md-4">
                <h6>Sort By</h6>
                {{ filter_form.sort_by }}
              </div>

              <div class="col-12 text-end">
                <a href="{% url 'dashboard:admin_dashboard' %}" class="btn btn-outline-secondary me-2">
                  <i class="fas fa-undo me-1"></i>Reset
                </a>
                <button type="submit" class="btn btn-success">
                  <i class="fas fa-filter me-1"></i>Apply Filters
                </button>
              </div>
            </form>
          </div>
        </div>

        <!-- Complaints Table -->
        <div class="card-body p-0">
          <div class="table-responsive">
            <table class="table table-hover mb-0">
              <thead class="bg-light">
                <tr>
                  <th>ID</th>
                  <th>Title</th>
                  <th>Category</th>
                  <th>Location</th>
                  <th>Reported By</th>
                  <th>Date</th>
                  <th>Status</th>
                  <th>Assigned To</th>
                  <th class="text-end">Actions</th>
                </tr>
              </thead>
              <tbody>
                {% for complaint in all_complaints %}
                <tr>
                  <td><strong>#{{ complaint.id }}</strong></td>
                  <td>{{ complaint.title }}</td>
                  <td>
                    <span class="badge {% if complaint.category == 'air' %}bg-info{% elif complaint.category == 'water' %}bg-primary{% elif complaint.category == 'waste' %}bg-warning{% elif complaint.category == 'noise' %}bg-danger{% else %}bg-secondary{% endif %} rounded-pill">
                      {{ complaint.get_category_display }}
                    </span>
                  </td>
                  <td>{{ complaint.get_location_display }}</td>
                  <td>{{ complaint.user.email }}</td>
                  <td>{{ complaint.date_submitted|date:"M d, Y" }}</td>
                  <td>
                    <span class="badge {% if complaint.status == 'Pending' %}bg-warning{% elif complaint.status == 'In Progress' %}bg-info{% elif complaint.status == 'Resolved' %}bg-success{% else %}bg-secondary{% endif %} rounded-pill">
                      {{ complaint.status }}
                    </span>
                  </td>
                  <td>
                    {% if complaint.assigned_officer %}
                      {{ complaint.assigned_officer.email }}
                    {% else %}
                      <span class="text-muted">Unassigned</span>
                    {% endif %}
                  </td>
                  <td class="text-end">
                    <!-- Dropdown for complaint actions -->
                    <div class="dropdown">
                      <button class="btn btn-sm btn-outline-success dropdown-toggle" type="button" id="dropdownMenuButton{{ complaint.id }}" data-bs-toggle="dropdown" aria-expanded="false">
                        Actions
                      </button>
                      <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdownMenuButton{{ complaint.id }}">
                        <li>
                          <a class="dropdown-item" href="{% url 'complaints:detail' pk=complaint.id %}">
                            <i class="fas fa-eye me-2"></i>View Details
                          </a>

                      </ul>
                    </div>





                  </td>
                </tr>
                {% empty %}
                <tr>
                  <td colspan="9" class="text-center py-4">
                    <div class="text-muted">
                      <i class="fas fa-inbox fa-3x mb-3"></i>
                      <p>No complaints found matching your criteria.</p>
                    </div>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>

        <!-- Pagination -->
        {% if all_complaints.has_other_pages %}
        <div class="card-footer bg-transparent">
          <nav aria-label="Page navigation">
            <ul class="pagination justify-content-center mb-0">
              {% if all_complaints.has_previous %}
                <li class="page-item">
                  <a class="page-link" href="?page={{ all_complaints.previous_page_number }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">
                    <i class="fas fa-chevron-left"></i>
                  </a>
                </li>
              {% else %}
                <li class="page-item disabled">
                  <span class="page-link"><i class="fas fa-chevron-left"></i></span>
                </li>
              {% endif %}

              {% for num in all_complaints.paginator.page_range %}
                {% if all_complaints.number == num %}
                  <li class="page-item active"><span class="page-link">{{ num }}</span></li>
                {% elif num > all_complaints.number|add:'-3' and num < all_complaints.number|add:'3' %}
                  <li class="page-item">
                    <a class="page-link" href="?page={{ num }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">{{ num }}</a>
                  </li>
                {% endif %}
              {% endfor %}

              {% if all_complaints.has_next %}
                <li class="page-item">
                  <a class="page-link" href="?page={{ all_complaints.next_page_number }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">
                    <i class="fas fa-chevron-right"></i>
                  </a>
                </li>
              {% else %}
                <li class="page-item disabled">
                  <span class="page-link"><i class="fas fa-chevron-right"></i></span>
                </li>
              {% endif %}
            </ul>
          </nav>
        </div>
        {% endif %}
      </div>
    </div>
    {% endif %}
    <!-- End of Complaints Management Content -->

    <!-- Officer Management Content -->
    {% if active_tab == 'officers' %}
      <div class="card border-0 shadow-lg mb-4" style="background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); border-radius: 15px;">
        <div class="card-header bg-transparent py-4 border-0">
          <div class="d-flex justify-content-between align-items-center">
            <div class="d-flex align-items-center">
              <div class="bg-success rounded-circle d-inline-flex align-items-center justify-content-center me-3" style="width: 45px; height: 45px;">
                <i class="fas fa-users text-white"></i>
              </div>
              <h4 class="card-title mb-0 text-success">Environmental Officers</h4>
            </div>
            <div>
              <a href="{% url 'accounts:add_user' %}" class="btn btn-success">
                <i class="fas fa-user-plus"></i> Add New Officer
              </a>

            </div>
          </div>
        </div>


        <!-- Officers Table -->
        <div class="card-body p-0">
          <div class="table-responsive">
            <table class="table table-hover mb-0">
              <thead class="bg-light">
                <tr>
                  <th>ID</th>
                  <th>Email</th>
                  <th>Constituency</th>
                  <th>Active</th>
                  <th>Assigned Cases</th>
                  <th>Resolution Rate</th>
                  <th class="text-end">Actions</th>
                </tr>
              </thead>
              <tbody>
                {% for officer in officers_filtered %}
                <tr>
                  <td><strong>#{{ officer.id }}</strong></td>
                  <td>{{ officer.email }}</td>
                  <td>{{ officer.get_location_display }}</td>
                  <td>
                    <span class="badge bg-success rounded-pill">Active</span>
                  </td>
                  <td>
                    {{ officer.assigned_complaints.count }}
                  </td>
                  <td>
                    {% with resolved=officer.assigned_complaints.filter.count|default:0 total=officer.assigned_complaints.count|default:1 %}
                      {% if total > 0 %}
                        <div class="progress" style="height: 10px;">
                          <div class="progress-bar bg-success" role="progressbar" style="width: {{ resolved|floatformat:0 }}%;" aria-valuenow="{{ resolved|floatformat:0 }}" aria-valuemin="0" aria-valuemax="100"></div>
                        </div>
                        <small class="text-muted">{{ resolved|floatformat:0 }}%</small>
                      {% else %}
                        <span class="text-muted">No cases</span>
                      {% endif %}
                    {% endwith %}
                  </td>
                  <td class="text-end">
                    <a href="{% url 'dashboard:edit_officer' officer.id %}" class="btn btn-sm btn-outline-success">
                      <i class="fas fa-edit me-1"></i> Edit Officer
                    </a>
                  </td>
                </tr>
                {% empty %}
                <tr>
                  <td colspan="7" class="text-center py-4">
                    <div class="text-muted">
                      <i class="fas fa-user-slash fa-3x mb-3"></i>
                      <p>No officers found matching your criteria.</p>
                    </div>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
    {% endif %}
    <!-- End of Officer Management Content -->

    <!-- Reports & Analytics Content -->
    {% if active_tab == 'reports' %}
      <div class="card border-0 shadow-lg mb-4" style="background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); border-radius: 15px;">
        <div class="card-header bg-transparent py-4 border-0">
          <div class="d-flex justify-content-between align-items-center">
            <div class="d-flex align-items-center">
              <div class="bg-success rounded-circle d-inline-flex align-items-center justify-content-center me-3" style="width: 45px; height: 45px;">
                <i class="fas fa-chart-bar text-white"></i>
              </div>
              <h4 class="card-title mb-0 text-success">Environmental Reports</h4>
            </div>
            <div>
              <a href="{% url 'dashboard:generate_report' %}" id="generateReportBtn" class="btn btn-success" onclick="generatePdfReport()">
                <i class="fas fa-file-pdf me-2"></i>Generate PDF Report
              </a>
            </div>
          </div>
        </div>

        <!-- Loading indicator for charts -->
        <div id="chartsLoading" class="text-center py-5">
          <div class="spinner-border text-success" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
          <p class="mt-3 text-muted">Loading environmental data...</p>
        </div>

        <div class="card-body" id="chartsContainer" style="display: none;">
          <div class="row g-4">
            <!-- Complaints by Status -->
            <div class="col-lg-6">
              <div class="card h-100 shadow-sm">
                <div class="card-header bg-light">
                  <h5 class="mb-0">Complaints by Status</h5>
                </div>
                <div class="card-body">
                  <canvas id="statusChart" height="250"></canvas>
                </div>
              </div>
            </div>

            <!-- Complaints by Category -->
            <div class="col-lg-6">
              <div class="card h-100 shadow-sm">
                <div class="card-header bg-light">
                  <h5 class="mb-0">Complaints by Category</h5>
                </div>
                <div class="card-body">
                  <canvas id="categoryChart" height="250"></canvas>
                </div>
              </div>
            </div>

            <!-- Monthly Complaints Trend -->
            <div class="col-lg-6">
              <div class="card h-100 shadow-sm">
                <div class="card-header bg-light">
                  <h5 class="mb-0">Monthly Complaint Trends</h5>
                </div>
                <div class="card-body">
                  <canvas id="monthlyTrendChart" height="250"></canvas>
                </div>
              </div>
            </div>

            <!-- Officer Workload -->
            <div class="col-lg-6">
              <div class="card h-100 shadow-sm">
                <div class="card-header bg-light">
                  <h5 class="mb-0">Officer Workload</h5>
                </div>
                <div class="card-body">
                  <canvas id="officerWorkloadChart" height="250"></canvas>
                </div>
              </div>
            </div>


          </div>
        </div>
      </div>
    </div>
    {% endif %}
    <!-- End of Reports & Analytics Content -->
      </div>
      <!-- End Content Section -->
      </div>
      </div>

    <!-- Add Chart.js for reports -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
      document.addEventListener('DOMContentLoaded', function() {
        // Only load charts if we're on the reports tab
        if ('{{ active_tab }}' === 'reports') {
          loadChartData();
        }

        // Function to fetch data from API and initialize charts
        function loadChartData() {
          fetch('{% url "api:complaint_trend_data" %}')
            .then(response => {
              if (!response.ok) {
                throw new Error('Network response was not ok');
              }
              return response.json();
            })
            .then(data => {
              // Hide loading indicator and show charts
              document.getElementById('chartsLoading').style.display = 'none';
              document.getElementById('chartsContainer').style.display = 'block';

              // Initialize charts with real data
              initializeStatusChart(data.statuses);
              initializeCategoryChart(data.categories);
              initializeMonthlyTrendChart(data.monthly);
              initializeOfficerWorkloadChart();
              initializeLocationChart();
            })
            .catch(error => {
              console.error('Error fetching chart data:', error);
              document.getElementById('chartsLoading').innerHTML = `
                <div class="alert alert-danger">
                  <i class="fas fa-exclamation-triangle me-2"></i>
                  Error loading chart data. Please try again later.
                </div>
              `;
            });
        }

        // Initialize Status Chart with real data
        function initializeStatusChart(statusData) {
          const statusCtx = document.getElementById('statusChart').getContext('2d');

          // Extract labels and data from API response
          const labels = statusData.map(item => item.status);
          const counts = statusData.map(item => item.count);

          // Define colors for different statuses
          const backgroundColors = labels.map(status => {
            switch(status) {
              case 'Pending': return '#f39c12';
              case 'In Progress': return '#3498db';
              case 'Resolved': return '#2ecc71';
              case 'Closed': return '#95a5a6';
              default: return '#34495e';
            }
          });

          new Chart(statusCtx, {
            type: 'pie',
            data: {
              labels: labels,
              datasets: [{
                data: counts,
                backgroundColor: backgroundColors,
                borderWidth: 0
              }]
            },
            options: {
              responsive: true,
              plugins: {
                legend: {
                  position: 'right',
                }
              }
            }
          });
        }

        // Initialize Category Chart with real data
        function initializeCategoryChart(categoryData) {
          const categoryCtx = document.getElementById('categoryChart').getContext('2d');

          // Extract labels and data
          const labels = categoryData.map(item => {
            // Capitalize the first letter of each category
            return item.category.charAt(0).toUpperCase() + item.category.slice(1);
          });
          const counts = categoryData.map(item => item.count);

          new Chart(categoryCtx, {
            type: 'bar',
            data: {
              labels: labels,
              datasets: [{
                label: 'Number of Complaints',
                data: counts,
                backgroundColor: '#3498db'
              }]
            },
            options: {
              responsive: true,
              scales: {
                y: {
                  beginAtZero: true
                }
              }
            }
          });
        }

        // Initialize Monthly Trend Chart
        function initializeMonthlyTrendChart(monthlyData) {
          const trendCtx = document.getElementById('monthlyTrendChart').getContext('2d');

          // Extract months and counts
          const months = monthlyData.map(item => item.month);
          const counts = monthlyData.map(item => item.count);

          new Chart(trendCtx, {
            type: 'line',
            data: {
              labels: months,
              datasets: [{
                label: 'Complaints Reported',
                data: counts,
                borderColor: '#2ecc71',
                backgroundColor: 'rgba(46, 204, 113, 0.2)',
                tension: 0.1,
                fill: true
              }]
            },
            options: {
              responsive: true,
              scales: {
                y: {
                  beginAtZero: true,
                  ticks: {
                    precision: 0
                  }
                }
              }
            }
          });
        }

        // Initialize Officer Workload Chart
        // Using data from the page context since the API doesn't provide this
        function initializeOfficerWorkloadChart() {
          const workloadCtx = document.getElementById('officerWorkloadChart').getContext('2d');

          // Use existing officer data from the template context
          const officers = [
            {% for officer in all_officers %}
              {% if officer.assigned_complaints.count > 0 %}
              {
                email: '{{ officer.email }}',
                count: {{ officer.assigned_complaints.count }}
              },
              {% endif %}
            {% endfor %}
          ];

          // Only display top 5 officers by workload if we have many
          let displayOfficers = officers;
          if (officers.length > 5) {
            displayOfficers = officers
              .sort((a, b) => b.count - a.count)
              .slice(0, 5);
          }

          const labels = displayOfficers.map(officer => officer.email);
          const counts = displayOfficers.map(officer => officer.count);

          new Chart(workloadCtx, {
            type: 'bar',
            data: {
              labels: labels,
              datasets: [{
                label: 'Assigned Cases',
                data: counts,
                backgroundColor: '#9b59b6'
              }]
            },
            options: {
              indexAxis: 'y',
              responsive: true,
              scales: {
                x: {
                  beginAtZero: true,
                  ticks: {
                    precision: 0
                  }
                }
              }
            }
          });
        }

        // Initialize Location Chart
        // Using data from the page context
        function initializeLocationChart() {
          const locationCtx = document.getElementById('locationChart').getContext('2d');

          // Create location data from the context
          const locationData = [
            {% for location_code, location_name in locations %}
            {
              location: '{{ location_name }}',
              count: {{ all_complaints.filter.count|default:0 }}
            },
            {% endfor %}
          ];

          const labels = locationData.map(item => item.location);
          const counts = locationData.map(item => item.count);

          new Chart(locationCtx, {
            type: 'bar',
            data: {
              labels: labels,
              datasets: [{
                label: 'Number of Complaints',
                data: counts,
                backgroundColor: '#2ecc71'
              }]
            },
            options: {
              responsive: true,
              scales: {
                y: {
                  beginAtZero: true,
                  ticks: {
                    precision: 0
                  }
                }
              }
            }
          });
        }
      });

      // Function to generate and download PDF report
      function generatePdfReport() {
        // Show loading indicator
        const btn = document.getElementById('generateReportBtn');
        const originalText = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Generating PDF...';
        btn.disabled = true;

        // Create a hidden form to submit the current filters to the report generator
        const form = document.createElement('form');
        form.method = 'GET';

        // Get all filter parameters from the current URL except 'tab'
        const urlParams = new URLSearchParams(window.location.search);
        urlParams.forEach((value, key) => {
          if (key !== 'tab') { // Skip the tab parameter
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = key;
            input.value = value;
            form.appendChild(input);
          }
        });

        document.body.appendChild(form);

        // Submit the form (will download the PDF)
        form.submit();

        // Reset button state after a short delay
        setTimeout(function() {
          btn.innerHTML = originalText;
          btn.disabled = false;
          document.body.removeChild(form);
        }, 2000);
      }
    </script>
    {% endblock %}
